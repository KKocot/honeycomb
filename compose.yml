# Requires .env file in this directory with DOMAIN variable
# Docker Compose reads .env automatically from the same directory
services:
  # Next.js docs (standalone, port 3030, basePath: /docs)
  docs:
    build:
      context: .
      dockerfile: Dockerfile.docs
    image: honeycomb-docs:latest
    container_name: honeycomb-docs
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp
      - /app/.next/cache
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - common_proxy_network
    expose:
      - "3030"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3030/docs"]
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=common_proxy_network"
      # --- Shared middlewares (defined once on docs service) ---
      # Redirect: / -> /docs
      - "traefik.http.middlewares.honeycomb-redirect.redirectregex.regex=^(https?)://([^/]+)/?$$"
      - "traefik.http.middlewares.honeycomb-redirect.redirectregex.replacement=$${1}://$${2}/docs"
      - "traefik.http.middlewares.honeycomb-redirect.redirectregex.permanent=false"
      # Security headers
      - "traefik.http.middlewares.honeycomb-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.honeycomb-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.honeycomb-security.headers.sslRedirect=true"
      - "traefik.http.middlewares.honeycomb-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.honeycomb-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.honeycomb-security.headers.stsPreload=true"
      - "traefik.http.middlewares.honeycomb-security.headers.customFrameOptionsValue=SAMEORIGIN"
      # --- Root redirect router (/ -> /docs) ---
      - "traefik.http.routers.honeycomb-root.rule=Host(`${DOMAIN}`) && Path(`/`)"
      - "traefik.http.routers.honeycomb-root.entrypoints=websecure"
      - "traefik.http.routers.honeycomb-root.tls=true"
      - "traefik.http.routers.honeycomb-root.tls.certresolver=letsencrypt"
      - "traefik.http.routers.honeycomb-root.middlewares=honeycomb-security,honeycomb-redirect"
      - "traefik.http.routers.honeycomb-root.service=honeycomb-docs"
      - "traefik.http.routers.honeycomb-root.priority=100"
      # --- Docs router (/docs) ---
      - "traefik.http.routers.honeycomb-docs.rule=Host(`${DOMAIN}`) && PathPrefix(`/docs`)"
      - "traefik.http.routers.honeycomb-docs.entrypoints=websecure"
      - "traefik.http.routers.honeycomb-docs.tls=true"
      - "traefik.http.routers.honeycomb-docs.tls.certresolver=letsencrypt"
      - "traefik.http.routers.honeycomb-docs.middlewares=honeycomb-security"
      - "traefik.http.routers.honeycomb-docs.service=honeycomb-docs"
      # --- Docs service ---
      - "traefik.http.services.honeycomb-docs.loadbalancer.server.port=3030"
      - "traefik.http.services.honeycomb-docs.loadbalancer.healthcheck.path=/docs"
      - "traefik.http.services.honeycomb-docs.loadbalancer.healthcheck.interval=30s"

  # Next.js demo-react (standalone, port 3031, basePath: /demo/react)
  demo-react:
    build:
      context: .
      dockerfile: Dockerfile.demo-react
    image: honeycomb-demo-react:latest
    container_name: honeycomb-demo-react
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp
      - /app/.next/cache
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - common_proxy_network
    expose:
      - "3031"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3031/demo/react"]
      interval: 30s
      timeout: 5s
      start_period: 30s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=common_proxy_network"
      # --- Demo React router (/demo/react) ---
      - "traefik.http.routers.honeycomb-demo-react.rule=Host(`${DOMAIN}`) && PathPrefix(`/demo/react`)"
      - "traefik.http.routers.honeycomb-demo-react.entrypoints=websecure"
      - "traefik.http.routers.honeycomb-demo-react.tls=true"
      - "traefik.http.routers.honeycomb-demo-react.tls.certresolver=letsencrypt"
      - "traefik.http.routers.honeycomb-demo-react.middlewares=honeycomb-security"
      - "traefik.http.routers.honeycomb-demo-react.service=honeycomb-demo-react"
      # --- Demo React service ---
      - "traefik.http.services.honeycomb-demo-react.loadbalancer.server.port=3031"
      - "traefik.http.services.honeycomb-demo-react.loadbalancer.healthcheck.path=/demo/react"
      - "traefik.http.services.honeycomb-demo-react.loadbalancer.healthcheck.interval=30s"

  # nginx static demos: Solid + Vue (port 8080)
  demos:
    build:
      context: .
      dockerfile: Dockerfile.demos
    image: honeycomb-demos:latest
    container_name: honeycomb-demos
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:uid=101,gid=101
      - /var/cache/nginx:uid=101,gid=101
      - /var/run:uid=101,gid=101
      - /var/log/nginx:uid=101,gid=101
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    networks:
      - common_proxy_network
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8080/demo/solid/"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=common_proxy_network"
      # --- Demos router (/demo/solid, /demo/vue) ---
      - "traefik.http.routers.honeycomb-demos.rule=Host(`${DOMAIN}`) && (PathPrefix(`/demo/solid`) || PathPrefix(`/demo/vue`))"
      - "traefik.http.routers.honeycomb-demos.entrypoints=websecure"
      - "traefik.http.routers.honeycomb-demos.tls=true"
      - "traefik.http.routers.honeycomb-demos.tls.certresolver=letsencrypt"
      - "traefik.http.routers.honeycomb-demos.middlewares=honeycomb-security"
      - "traefik.http.routers.honeycomb-demos.service=honeycomb-demos"
      # --- Demos service ---
      - "traefik.http.services.honeycomb-demos.loadbalancer.server.port=8080"
      - "traefik.http.services.honeycomb-demos.loadbalancer.healthcheck.path=/demo/solid/"
      - "traefik.http.services.honeycomb-demos.loadbalancer.healthcheck.interval=30s"

networks:
  common_proxy_network:
    external: true
